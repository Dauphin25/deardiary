{% extends "base.html" %}
{% load static %}
{% load diary_extras %}
{% block title %}{{ question_set.title }} - My Diary{% endblock %}

{% block meta_description %}
Description about "{{ question_set.title }}" question set ‚Äî answer your personal questions and reflect.
{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'diary/css/styles/grunge.css' %}">
{% endblock %}

{% block content %}
<div class="grunge-style diary-page">
  <!-- Added diary page wrapper and enhanced header structure -->
  <div class="diary-binding"></div>
  <div class="diary-content">
    <header class="question-set-header diary-header">
      <div class="diary-date">{{ question_set.created_at|date:"F d, Y" }}</div>
      <h2 class="grunge-title diary-title">{{ question_set.title }}</h2>

      {% if question_set.description %}
        <div class="diary-entry-description">
          <p class="question-set-description">{{ question_set.description }}</p>
        </div>
      {% endif %}

      {% if mode == "owner" %}
        <div class="diary-actions">
          <a href="{% url 'diary:view_all_responses' %}" class="btn btn-primary diary-btn">üìä View All Responses</a>
        </div>
      {% endif %}

      {% if mode == "view_answers" %}
        <div class="info-box diary-info">
          <div class="diary-metadata">
            <p><strong>Response from:</strong> <span class="highlight">{{ respondent.username|default:"Anonymous" }}</span></p>
            <p><strong>Created by:</strong> <span class="highlight">{{ question_set.owner.username }}</span></p>
          </div>
        </div>
      {% endif %}

      {% if mode == "answer" %}
        {# No share link shown while answering #}
      {% elif mode != "view_answers" %}
        <div class="share-section diary-share">
          <div class="diary-note">
            <p class="share-label"><strong>Share this diary entry:</strong></p>
            <div class="share-input-group">
              <input type="text" id="share-link" class="share-input diary-input"
                     value="{{ request.build_absolute_uri|cut:request.path }}{% url 'diary:answer_question_set_shared' question_set.share_uuid %}"
                     readonly>
              <button onclick="copyLink()" class="btn btn-secondary diary-btn">üìã Copy Link</button>
            </div>
          </div>
        </div>
      {% endif %}
    </header>

    <section class="questions-list diary-questions">
      <h3 class="section-title diary-section-title">Questions</h3>

      {% if mode == "owner" %}
        <div class="questions-grid diary-grid">
          {% for question in questions %}
            <div class="question-card diary-question">
              <div class="question-number">{{ forloop.counter }}</div>
              <p class="question-text">{{ question.text }}</p>
              <div class="question-actions diary-actions">
                <a href="{% url 'diary:edit_question' pk=question.pk %}" class="action-link edit">‚úèÔ∏è Edit</a>
                <span class="separator">|</span>
                <a href="{% url 'diary:delete_question' pk=question.pk %}" class="action-link delete" onclick="return confirm('Are you sure?')">üóëÔ∏è Delete</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% elif mode == "respond" or mode == "answer" %}
        <form method="post" class="answer-form diary-form">
          {% csrf_token %}
          <div class="questions-grid diary-grid">
            {% for question in questions %}
              <div class="question-card diary-question">
                <div class="question-number">{{ forloop.counter }}</div>
                <p class="question-text">{{ question.text }}</p>
                <div class="diary-answer-area">
                  <textarea name="question_{{ question.id }}" rows="4" class="answer-textarea diary-textarea" placeholder="Write your thoughts here..." required></textarea>
                </div>
              </div>
            {% endfor %}
          </div>
          <div class="form-actions diary-form-actions">
            <button type="submit" class="btn btn-primary submit-btn diary-submit">üì© Submit My Answers</button>
          </div>
        </form>
      {% elif mode == "view_answers" %}
        <div class="questions-grid diary-grid">
          {% for question in questions %}
            <div class="question-card answer-view diary-answer-view">
              <div class="question-number">{{ forloop.counter }}</div>
              <p class="question-text">{{ question.text }}</p>
              <div class="answer-box diary-answer">
                <div class="answer-label">Answer:</div>
                <p class="answer-text">{{ answers_dict|get_item:question.id }}</p>
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="back-link diary-navigation">
          <a href="{% url 'diary:view_all_responses' %}" class="btn btn-secondary diary-btn">üîô Back to all responses</a>
        </div>
      {% else %}
        <div class="questions-grid diary-grid">
          {% for question in questions %}
            <div class="question-card diary-question">
              <div class="question-number">{{ forloop.counter }}</div>
              <p class="question-text">{{ question.text }}</p>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </section>

    {% if request.user == question_set.owner %}
      <div class="danger-zone diary-danger">
        <div class="diary-warning">
          <h4>Danger Zone</h4>
          <p>This action cannot be undone</p>
        </div>
        <form method="post" action="{% url 'diary:question_set_delete' slug=question_set.slug %}" class="delete-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger diary-delete" onclick="return confirm('Are you sure you want to delete this diary entry? This action cannot be undone.')">üóëÔ∏è Delete This Entry</button>
        </form>
      </div>
    {% endif %}

    {% if mode == "owner" %}
      <section class="add-question-form diary-add-section">
        <h3 class="section-title diary-section-title">Add a new question</h3>
        <div class="diary-form-wrapper">
          <form method="post" class="new-question-form diary-form">
            {% csrf_token %}
            <div class="form-group diary-form-group">
              {{ form.as_p }}
            </div>
            <div class="form-actions diary-form-actions">
              <button type="submit" class="btn btn-primary diary-btn">‚ûï Add Question</button>
            </div>
          </form>
        </div>
      </section>
    {% endif %}
  </div>
</div>

<script>
  function copyLink() {
    const input = document.getElementById("share-link");
    input.select();
    input.setSelectionRange(0, 99999);

    try {
      document.execCommand("copy");
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = "‚úÖ Copied!";
      button.classList.add('copied');

      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('copied');
      }, 2000);
    } catch (err) {
      alert("Link copied to clipboard!");
    }
  }
</script>
{% endblock %}
